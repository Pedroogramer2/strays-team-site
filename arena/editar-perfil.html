<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações da Conta</title>
    
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f1116; color: white; }
        
        /* Input Customizado */
        .input-dark {
            width: 100%;
            background-color: #0f1116;
            border: 1px solid #2a2e35;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-dark:focus { border-color: #4a4d55; }
        .input-dark:disabled { color: #555; cursor: not-allowed; }

        .label-dark {
            display: block;
            color: #6b7280;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#0f1116] min-h-screen">

    <div class="max-w-5xl mx-auto px-8 pt-8">
        <a href="perfil.html" class="inline-flex items-center gap-2 text-gray-500 hover:text-white transition-colors font-bold text-sm">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar para o perfil
        </a>
    </div>

    <div class="max-w-5xl mx-auto px-8 py-8 animate-fadeIn">
        
        <div class="mb-10">
            <h1 class="text-3xl font-black text-white uppercase mb-2">CONFIGURAÇÕES DA SUA CONTA</h1>
            <p class="text-gray-500 text-sm">Gerencie todas as informações da sua conta</p>
        </div>

        <div class="bg-[#15171e] border border-gray-800 rounded-xl p-10 shadow-xl">
            
            <form id="edit-form" onsubmit="event.preventDefault(); saveProfile();">
                
                <div class="flex items-center gap-8 mb-10 pb-10 border-b border-gray-800">
                    <div class="w-24 h-24 rounded-full bg-[#0f1116] border-2 border-gray-700 overflow-hidden relative shrink-0">
                        <img id="edit-avatar-img" src="" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <label for="file-upload-profile" class="bg-[#1c1f26] border border-gray-700 hover:bg-gray-700 text-white px-5 py-2.5 rounded-lg text-xs font-bold transition-colors cursor-pointer inline-block tracking-wide uppercase">
                            Enviar nova foto
                        </label>
                        <input type="file" id="file-upload-profile" class="hidden" accept="image/*" onchange="previewProfileImage(event)">
                        <p class="text-gray-600 text-[11px] mt-3 leading-relaxed">
                            Recomendamos uma imagem 500x500.<br>Apenas PNG, JPEG, JPG e WEBP.
                        </p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="label-dark">PRIMEIRO NOME</label>
                            <input type="text" id="edit-name" class="input-dark" placeholder="Seu nome">
                        </div>
                        <div>
                            <label class="label-dark">SEU E-MAIL</label>
                            <input type="text" id="edit-email" disabled class="input-dark">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="label-dark">BIO</label>
                            <input type="text" id="edit-bio" class="input-dark" placeholder="Escreva algo...">
                        </div>
                        <div>
                            <label class="label-dark">NICK</label>
                            <input type="text" id="edit-nick" class="input-dark font-bold text-white" placeholder="Seu Nick">
                        </div>
                    </div>

                    <div class="pt-4">
                        <h3 class="text-white font-bold text-sm mb-6">Redes Sociais</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="label-dark">TWITTER (X)</label>
                                <div class="relative">
                                    <div class="absolute left-4 top-3.5 text-gray-500"><i data-lucide="twitter" class="w-4 h-4"></i></div>
                                    <input type="text" id="edit-twitter" placeholder="@exemplo" class="input-dark pl-10">
                                </div>
                            </div>
                            
                            <div>
                                <label class="label-dark">INSTAGRAM</label>
                                <div class="relative">
                                    <div class="absolute left-4 top-3.5 text-gray-500"><i data-lucide="instagram" class="w-4 h-4"></i></div>
                                    <input type="text" id="edit-instagram" placeholder="@exemplo" class="input-dark pl-10">
                                </div>
                            </div>

                            <div>
                                <label class="label-dark">TWITCH</label>
                                <div class="relative">
                                    <div class="absolute left-4 top-3.5 text-gray-500"><i data-lucide="twitch" class="w-4 h-4"></i></div>
                                    <input type="text" id="edit-twitch" placeholder="canal" class="input-dark pl-10">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-10 mt-10 border-t border-gray-800 flex justify-end">
                    <button type="submit" id="save-btn" class="bg-[#FFD700] hover:bg-[#e6c200] text-black font-bold py-3 px-10 rounded-lg shadow-lg shadow-yellow-500/10 transition-all text-xs uppercase tracking-wider transform hover:scale-105">
                        Salvar Alterações
                    </button>
                </div>

            </form>
        </div>
    </div>

    <div class="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Configuração
        const firebaseConfig = {
            apiKey: "AIzaSyDaaBVNHZ6UOgHzb-pzT1RJxAT5yiQZLw0",
            authDomain: "site-strays.firebaseapp.com",
            projectId: "site-strays",
            storageBucket: "site-strays.firebasestorage.app", 
            messagingSenderId: "1005872178248",
            appId: "1:1005872178248:web:36dfa929ab008a4415e47d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        let currentUserUid = null;
        let selectedProfileFile = null;

        // --- FUNÇÃO DE TOAST (Copiada do main.js para funcionar aqui isoladamente) ---
        window.showToast = function(message, type = 'success') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            // O CSS .toast e .toast.error deve estar no style.css
            toast.className = type === 'error' ? 'toast bg-red-500 border-red-400' : 'toast';
            
            // Caso o style.css não defina .error, forçamos o estilo inline para garantir
            if (type === 'error') {
                toast.style.backgroundColor = '#ef4444'; // Vermelho
                toast.style.borderColor = 'rgba(255,255,255,0.2)';
            }

            const iconName = type === 'error' ? 'alert-circle' : 'check-circle';
            
            toast.innerHTML = `
                <div class="toast-icon"><i data-lucide="${iconName}" style="width:14px; height:14px;"></i></div>
                <span>${message}</span>
            `;

            container.appendChild(toast);
            if(window.lucide) lucide.createIcons();

            setTimeout(() => {
                // A animação fadeOutToast deve estar no style.css, se não, usamos opacity
                toast.style.transition = "all 0.5s ease";
                toast.style.transform = "translateX(120%)";
                toast.style.opacity = "0";
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // Check Auth
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserUid = user.uid;
                    loadUserProfile(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });
        });

        async function loadUserProfile(uid) {
            const local = localStorage.getItem('strays_user');
            if(local) fillForm(JSON.parse(local));

            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    fillForm(data);
                    if(local) {
                        const merged = { ...JSON.parse(local), ...data };
                        localStorage.setItem('strays_user', JSON.stringify(merged));
                    }
                }
            } catch (e) { console.error(e); }
        }

        function fillForm(data) {
            document.getElementById('edit-name').value = data.name || "";
            document.getElementById('edit-email').value = data.email || "";
            document.getElementById('edit-nick').value = data.nick || data.name || "";
            document.getElementById('edit-bio').value = data.bio || "";
            
            const avatar = document.getElementById('edit-avatar-img');
            avatar.src = data.photo || `https://api.dicebear.com/7.x/initials/svg?seed=${data.name}`;

            if(data.socials) {
                document.getElementById('edit-twitter').value = data.socials.twitter || "";
                document.getElementById('edit-instagram').value = data.socials.instagram || "";
                document.getElementById('edit-twitch').value = data.socials.twitch || "";
            }
        }

        window.previewProfileImage = function(event) {
            const file = event.target.files[0];
            if (file) {
                selectedProfileFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-avatar-img').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        window.saveProfile = async function() {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerText;
            btn.innerText = "SALVANDO..."; btn.disabled = true;

            try {
                let photoUrl = document.getElementById('edit-avatar-img').src;

                if (selectedProfileFile) {
                    const storageRef = ref(storage, `users/${currentUserUid}/profile_${Date.now()}.jpg`);
                    const snapshot = await uploadBytes(storageRef, selectedProfileFile);
                    photoUrl = await getDownloadURL(snapshot.ref);
                }

                const newData = {
                    nick: document.getElementById('edit-nick').value,
                    name: document.getElementById('edit-name').value,
                    bio: document.getElementById('edit-bio').value,
                    photo: photoUrl,
                    socials: {
                        twitter: document.getElementById('edit-twitter').value,
                        instagram: document.getElementById('edit-instagram').value,
                        twitch: document.getElementById('edit-twitch').value
                    }
                };

                await updateDoc(doc(db, "users", currentUserUid), newData);

                const localUser = JSON.parse(localStorage.getItem('strays_user') || '{}');
                const updatedUser = { ...localUser, ...newData };
                localStorage.setItem('strays_user', JSON.stringify(updatedUser));

                // SUBSTITUÍDO: Alert por Toast
                showToast("Perfil salvo com sucesso!", "success");
                
                // Pequeno delay para ler o toast antes de sair
                setTimeout(() => {
                    window.location.href = 'perfil.html';
                }, 1500);

            } catch (error) {
                console.error(error);
                // SUBSTITUÍDO: Alert por Toast
                showToast("Erro ao salvar: " + error.message, "error");
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }
    </script>
</body>
</html>